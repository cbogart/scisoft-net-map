{% extends "app_base.jinja2" %}

{% block head %}
  {{ super() }}
  <link href="{{request.static_url('snmweb:static/css/lib/nv.d3.css')}}" rel="stylesheet">
  <style>
    #chart svg {
      height: 400px;
    }
  </style>
{% endblock %}

{% block js %}
  {{ super() }}
  <script src="{{request.static_url('snmweb:static/js/lib/d3.min.js')}}"></script>
  <script src="{{request.static_url('snmweb:static/js/lib/nv.d3.min.js')}}"></script>
  <script>

    function clear_diagram(){
      $("#graph-data tbody").empty();
      $("#chart svg").empty();
    }

    function draw_diagram(period) {
    function data(period) {
      var appData = [];

      $.ajaxSetup({
        async: false
      });

      $.getJSON("{{request.route_path('api_home')}}" +
        "/stat/usage_over_time?group_by="+period,
        function(data) {
          function addRow(date, value) {
            $("#graph-data tbody").append(
              $('<tr>')
                .append($('<td>').text(date))
                .append($('<td>').text(value))
            )
          }
          var dates = data["data"]["dates"];
          var runs = data["data"]["runs"];
          var parseDate = d3.time.format("%Y-%m-%d").parse;
          var x, y;
            for (var i = 0; i < dates.length; i++) {
                x = parseDate(dates[i]);
                y = runs[i];
                appData.push({'x': x, 'y': y});
                addRow(dates[i],y);
            }
          });

      return [
        {
          values: appData,
          key: "Application",
          color: "#ff7f0e"
        }
      ];
    }

    nv.addGraph(function() {
      var chart = nv.models.lineChart()
      .useInteractiveGuideline(true)
      ;

      chart.xAxis
      .axisLabel("Date")
      .tickFormat(function(d) {
          return d3.time.format("%x")(new Date(d));
          });

      chart.yAxis
      .axisLabel("Runs")
      .tickFormat(d3.format(".0f"))
      ;

      d3.select("#chart svg")
      .datum(data(period))
      .transition().duration(500)
      .call(chart)
      ;

      nv.utils.windowResize(chart.update);

      return chart;
    });

    }

  $(function main() {
    var btns = $("#filters-group button");
    btns.click(function(){
      btns.removeClass("active");
      $(this).addClass("active");
      clear_diagram();
      draw_diagram($(this).data("period"));
    });
    draw_diagram("day");
  });
  </script>
{% endblock %}

{% block details %}
  <h2>Usage over time</h2>
  <div class="panel-body">
    <div id="chart">
      <svg></svg>
    </div>
    <div class="row" id="filters">
      <div id="filters-group" class="btn-group">
        <button type="button" class="btn disabled">Period:</button>
        <button data-period="day" type="button" class="btn active
        btn-default">Day</button>
        <button data-period="week" type="button" class="btn
        btn-default">Week</button>
        <button data-period="month" type="button" class="btn
        btn-default">Month</button>
      </div>
      <div class="btn-group">
        <button type="button" class="btn disabled">Time range:</button>
        <button type="button" class="btn disabled btn-default">From: October 2013</button>
        <button type="button" class="btn disabled btn-default">To: April 2014</button>
      </div>
      <div class="btn-group">
        <button type="button" class="btn disabled">Smoothness:</button>
        <button type="button" class="btn active btn-default">None</button>
        <button type="button" class="btn disabled btn-default">3</button>
        <button type="button" class="btn disabled btn-default">5</button>
        <button type="button" class="btn disabled btn-default">7</button>
      </div>
    </div>

    <table class="table" id="graph-data">
      <thead>
        <tr>
          <th>Date</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>
{% endblock %}
